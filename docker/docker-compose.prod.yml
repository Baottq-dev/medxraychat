# MedXrayChat - Production Docker Compose (GPU Server + HTTPS)
# Full pipeline: YOLO + Qwen3-VL + Frontend + SSL tự động
#
# Yêu cầu:
#   1. NVIDIA GPU với >= 16GB VRAM
#   2. Domain đã trỏ A Record về IP của VM
#   3. Port 80, 443 đã mở trên GCP Firewall
#
# Sử dụng:
#   1. Copy .env.prod.example to .env và điền các giá trị
#   2. docker compose -f docker-compose.prod.yml up -d --build

services:
  # Traefik Reverse Proxy - Tự động SSL từ Let's Encrypt
  traefik:
    image: traefik:v2.11
    container_name: medxraychat-traefik
    restart: always
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=medxray-network"
      # HTTP -> HTTPS redirect
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      # HTTPS
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.websecure.http.tls.certResolver=letsencrypt"
      # Let's Encrypt
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      - "--log.level=INFO"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "letsencrypt_data:/letsencrypt"
    networks:
      - medxray-network

  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: medxraychat-db
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-medxray}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-medxraychat}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-medxray}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - medxray-network

  # Redis for caching
  redis:
    image: redis:7-alpine
    container_name: medxraychat-redis
    restart: always
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - medxray-network

  # FastAPI Backend with AI (GPU)
  backend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.backend
    container_name: medxraychat-backend
    restart: always
    environment:
      - DEBUG=${DEBUG:-true}
      - PRELOAD_AI_MODELS=true
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER:-medxray}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB:-medxraychat}
      - REDIS_URL=redis://redis:6379
      - SECRET_KEY=${SECRET_KEY}
      - MOCK_QWEN_SERVICE=${MOCK_QWEN_SERVICE:-false}
      - AI_DEVICE=auto
      - YOLO_MODEL_PATH=/app/weights/yolo/best.pt
      - QWEN_MODEL_NAME=/app/weights/qwen
    volumes:
      - uploads_data:/app/uploads
      - ../weights:/app/weights:ro
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      start_period: 120s
      retries: 3
    networks:
      - medxray-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend.rule=Host(`${DOMAIN}`) && (PathPrefix(`/api`) || PathPrefix(`/health`) || PathPrefix(`/docs`) || PathPrefix(`/openapi.json`))"
      - "traefik.http.routers.backend.entrypoints=websecure"
      - "traefik.http.routers.backend.tls.certresolver=letsencrypt"
      - "traefik.http.services.backend.loadbalancer.server.port=8000"

  # Next.js Frontend
  frontend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.frontend
      args:
        - NEXT_PUBLIC_API_URL=https://${DOMAIN}/api/v1
        - NEXT_PUBLIC_WS_URL=wss://${DOMAIN}/api/v1/ws
    container_name: medxraychat-frontend
    restart: always
    healthcheck:
      disable: true
    environment:
      - NEXT_PUBLIC_API_URL=https://${DOMAIN}/api/v1
      - NEXT_PUBLIC_WS_URL=wss://${DOMAIN}/api/v1/ws
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - medxray-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls.certresolver=letsencrypt"
      - "traefik.http.routers.frontend.priority=1"
      - "traefik.http.services.frontend.loadbalancer.server.port=3000"

volumes:
  postgres_data:
  redis_data:
  uploads_data:
  letsencrypt_data:

networks:
  medxray-network:
    driver: bridge
